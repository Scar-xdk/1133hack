<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>kdefy</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #ffffff;
            --bg-secondary: #f8f9fa;
            --bg-card: #ffffff;
            --text-primary: #1a1a1a;
            --text-secondary: #6c757d;
            --border: #e9ecef;
            --accent: #5B2CFF;
            --success: #00C853;
            --danger: #FF3D00;
            --sidebar-width: 280px;
            --sidebar-collapsed: 70px;
            --shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        body.dark {
            --bg-primary: #1a1a1a;
            --bg-secondary: #2d2d2d;
            --bg-card: #242424;
            --text-primary: #ffffff;
            --text-secondary: #a0a0a0;
            --border: #3d3d3d;
            --shadow: 0 2px 8px rgba(0,0,0,0.3);
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            transition: background 0.3s, color 0.3s;
        }

        .landing-page {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .landing-nav {
            padding: 1.5rem 2rem;
            background: var(--bg-card);
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: var(--shadow);
        }

        .landing-logo {
            font-size: 1.8rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--accent), #7B4CFF);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .landing-nav button {
            padding: 0.75rem 2rem;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .landing-nav button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(91, 44, 255, 0.3);
        }

        .hero {
            padding: 6rem 2rem;
            text-align: center;
            background: linear-gradient(135deg, var(--bg-secondary), var(--bg-primary));
        }

        .hero h1 {
            font-size: 3.5rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
            background: linear-gradient(135deg, var(--accent), #7B4CFF);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .hero p {
            font-size: 1.3rem;
            color: var(--text-secondary);
            max-width: 600px;
            margin: 0 auto 2rem;
        }

        .section {
            padding: 4rem 2rem;
            max-width: 1200px;
            margin: 0 auto;
        }

        .section h2 {
            font-size: 2.5rem;
            margin-bottom: 2rem;
            text-align: center;
        }

        .features {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
            margin-top: 3rem;
        }

        .feature-card {
            padding: 2rem;
            background: var(--bg-card);
            border-radius: 12px;
            box-shadow: var(--shadow);
            text-align: center;
            transition: transform 0.3s;
        }

        .feature-card:hover {
            transform: translateY(-5px);
        }

        .feature-card h3 {
            font-size: 1.5rem;
            margin: 1rem 0;
        }

        .faq-item {
            background: var(--bg-card);
            padding: 1.5rem;
            margin-bottom: 1rem;
            border-radius: 8px;
            box-shadow: var(--shadow);
        }

        .faq-item h3 {
            margin-bottom: 0.5rem;
            color: var(--accent);
        }

        .app-container {
            display: none;
            min-height: 100vh;
        }

        .app-container.active {
            display: flex;
        }

        .sidebar {
            width: var(--sidebar-width);
            background: var(--bg-card);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            position: fixed;
            height: 100vh;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), width 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 1000;
            overflow: hidden;
        }

        .sidebar.collapsed {
            width: var(--sidebar-collapsed);
        }

        .sidebar-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--accent), #7B4CFF);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            white-space: nowrap;
            opacity: 1;
            transition: opacity 0.3s;
        }

        .sidebar.collapsed .logo {
            opacity: 0;
        }

        .toggle-btn {
            background: var(--bg-secondary);
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }

        .toggle-btn:hover {
            background: var(--border);
        }

        .menu {
            flex: 1;
            padding: 1rem;
            overflow-y: auto;
        }

        .menu-item {
            padding: 0.875rem 1rem;
            margin-bottom: 0.5rem;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 1rem;
            transition: background 0.2s;
            white-space: nowrap;
        }

        .menu-item:hover {
            background: var(--bg-secondary);
        }

        .menu-item.active {
            background: var(--accent);
            color: white;
        }

        .menu-item svg {
            min-width: 24px;
            width: 24px;
            height: 24px;
        }

        .menu-item span {
            opacity: 1;
            transition: opacity 0.3s;
        }

        .sidebar.collapsed .menu-item span {
            opacity: 0;
            width: 0;
        }

        .main-content {
            margin-left: var(--sidebar-width);
            transition: margin-left 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            flex: 1;
        }

        .sidebar.collapsed ~ .main-content {
            margin-left: var(--sidebar-collapsed);
        }

        .topbar {
            padding: 1.5rem 2rem;
            background: var(--bg-card);
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .balance {
            display: flex;
            flex-direction: column;
        }

        .balance-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .balance-value {
            font-size: 2rem;
            font-weight: 700;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .btn-primary {
            background: var(--accent);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(91, 44, 255, 0.3);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-secondary {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        .content {
            padding: 2rem;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .card {
            background: var(--bg-card);
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: var(--shadow);
        }

        .card-header {
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .filter-controls {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 0.5rem 1rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .filter-btn.active {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            margin-top: 0.5rem;
        }

        .stat-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .transaction-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .transaction-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background: var(--bg-secondary);
            border-radius: 8px;
            transition: transform 0.2s;
        }

        .transaction-item:hover {
            transform: translateX(5px);
        }

        .transaction-info {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .transaction-category {
            font-weight: 600;
        }

        .transaction-date {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .transaction-value {
            font-weight: 700;
            font-size: 1.125rem;
        }

        .transaction-value.income {
            color: var(--success);
        }

        .transaction-value.outcome {
            color: var(--danger);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--bg-card);
            padding: 2rem;
            border-radius: 12px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .form-input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: var(--bg-primary);
            color: var(--text-primary);
            font-size: 1rem;
        }

        .form-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            margin-top: 2rem;
        }

        .category-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1rem;
        }

        .category-item {
            padding: 1.5rem;
            background: var(--bg-secondary);
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .category-item:hover {
            transform: scale(1.05);
        }

        .category-color {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            margin: 0 auto 1rem;
        }

        .contract-container {
            background: var(--bg-secondary);
            padding: 2rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
            max-height: 400px;
            overflow-y: auto;
        }

        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }

            .sidebar.active {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
            }

            .dashboard-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="landing-page" id="landingPage">
        <nav class="landing-nav">
            <div class="landing-logo">kdefy</div>
            <button onclick="enterApp()">Entrar no Sistema</button>
        </nav>

        <section class="hero">
            <h1>Gerencie suas Finan√ßas com Intelig√™ncia</h1>
            <p>Controle total sobre suas transa√ß√µes, categorias e relat√≥rios financeiros. Tudo de forma simples, r√°pida e segura.</p>
            <button class="btn btn-primary" onclick="enterApp()">Come√ßar Agora</button>
        </section>

        <section class="section">
            <h2>Sobre o kdefy</h2>
            <div class="features">
                <div class="feature-card">
                    <h3>üìä Dashboard Completo</h3>
                    <p>Visualize seu saldo, gr√°ficos de entrada vs sa√≠da e distribui√ß√£o por categoria em tempo real.</p>
                </div>
                <div class="feature-card">
                    <h3>üí∞ Gest√£o de Transa√ß√µes</h3>
                    <p>Adicione, edite e remova transa√ß√µes com facilidade. Filtros inteligentes por per√≠odo e categoria.</p>
                </div>
                <div class="feature-card">
                    <h3>üé® Categorias Personalizadas</h3>
                    <p>Crie e customize suas pr√≥prias categorias com cores √∫nicas para melhor organiza√ß√£o.</p>
                </div>
                <div class="feature-card">
                    <h3>üìà Relat√≥rios Detalhados</h3>
                    <p>Gr√°ficos avan√ßados e exporta√ß√£o em CSV/PDF para an√°lises profundas.</p>
                </div>
                <div class="feature-card">
                    <h3>üìÑ Contratos Profissionais</h3>
                    <p>Gere contratos de servi√ßo, trabalho, aluguel e venda com um clique.</p>
                </div>
                <div class="feature-card">
                    <h3>üéØ Metas Financeiras</h3>
                    <p>Defina objetivos e acompanhe seu progresso para alcan√ßar suas metas.</p>
                </div>
            </div>
        </section>

        <section class="section">
            <h2>Perguntas Frequentes</h2>
            <div class="faq-item">
                <h3>Como funciona o sistema?</h3>
                <p>O kdefy armazena todos os seus dados localmente no seu navegador usando IndexedDB. Seus dados s√£o privados e seguros, sem necessidade de criar conta.</p>
            </div>
            <div class="faq-item">
                <h3>Posso exportar meus dados?</h3>
                <p>Sim! Voc√™ pode fazer backup completo dos seus dados em formato JSON e exportar relat√≥rios em CSV ou PDF.</p>
            </div>
            <div class="faq-item">
                <h3>√â gratuito?</h3>
                <p>Completamente gratuito! Sem taxas ocultas, sem assinaturas. Use quantas vezes quiser.</p>
            </div>
            <div class="faq-item">
                <h3>Funciona offline?</h3>
                <p>Sim! Ap√≥s o primeiro carregamento, o sistema funciona completamente offline.</p>
            </div>
        </section>

        <section class="section">
            <h2>Pol√≠tica de Privacidade</h2>
            <div class="faq-item">
                <h3>Armazenamento de Dados</h3>
                <p>Todos os dados s√£o armazenados localmente no seu navegador. N√£o coletamos, n√£o compartilhamos e n√£o vendemos suas informa√ß√µes.</p>
            </div>
            <div class="faq-item">
                <h3>Seguran√ßa</h3>
                <p>Seus dados financeiros permanecem no seu dispositivo. Recomendamos fazer backups regulares para evitar perda de dados.</p>
            </div>
            <div class="faq-item">
                <h3>Cookies</h3>
                <p>Utilizamos apenas armazenamento local (LocalStorage e IndexedDB) para salvar suas prefer√™ncias e dados. Nenhum cookie de rastreamento √© utilizado.</p>
            </div>
        </section>
    </div>

    <div class="app-container" id="appContainer">
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <span class="logo">kdefy</span>
                <button class="toggle-btn" onclick="toggleSidebar()">
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M2 8h12M2 4h12M2 12h12"/>
                    </svg>
                </button>
            </div>
            <nav class="menu" id="menu"></nav>
        </aside>

        <main class="main-content">
            <div class="topbar">
                <div class="balance">
                    <span class="balance-label">Saldo Total</span>
                    <span class="balance-value" id="totalBalance">R$ 0,00</span>
                </div>
                <div style="display: flex; gap: 1rem;">
                    <button class="btn btn-secondary" onclick="toggleTheme()">üåì Tema</button>
                    <button class="btn btn-primary" onclick="openTransactionModal()">+ Nova Transa√ß√£o</button>
                </div>
            </div>
            <div class="content" id="content"></div>
        </main>
    </div>

    <div class="modal" id="transactionModal">
        <div class="modal-content">
            <div class="modal-header">Adicionar Transa√ß√£o</div>
            <form id="transactionForm">
                <div class="form-group">
                    <label class="form-label">Valor</label>
                    <input type="number" class="form-input" id="transactionValue" step="0.01" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Tipo</label>
                    <select class="form-input" id="transactionType" required>
                        <option value="income">Entrada</option>
                        <option value="outcome">Sa√≠da</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Categoria</label>
                    <select class="form-input" id="transactionCategory" required></select>
                </div>
                <div class="form-group">
                    <label class="form-label">Data</label>
                    <input type="date" class="form-input" id="transactionDate" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Descri√ß√£o</label>
                    <input type="text" class="form-input" id="transactionDescription">
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeTransactionModal()">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <div class="modal" id="categoryModal">
        <div class="modal-content">
            <div class="modal-header">Adicionar Categoria</div>
            <form id="categoryForm">
                <div class="form-group">
                    <label class="form-label">Nome</label>
                    <input type="text" class="form-input" id="categoryName" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Cor</label>
                    <input type="color" class="form-input" id="categoryColor" value="#5B2CFF" required>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeCategoryModal()">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <div class="modal" id="goalModal">
        <div class="modal-content">
            <div class="modal-header">Adicionar Meta Financeira</div>
            <form id="goalForm">
                <div class="form-group">
                    <label class="form-label">Nome da Meta</label>
                    <input type="text" class="form-input" id="goalName" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Valor Alvo</label>
                    <input type="number" class="form-input" id="goalTarget" step="0.01" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Valor Atual</label>
                    <input type="number" class="form-input" id="goalCurrent" step="0.01" value="0" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Data Limite</label>
                    <input type="date" class="form-input" id="goalDeadline">
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeGoalModal()">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let db;
        let currentSection = 'dashboard';
        let editingTransactionId = null;
        let editingCategoryId = null;
        let editingGoalId = null;
        let transactionChart = null;
        let categoryChart = null;
        let evolutionChart = null;
        let categoryCompareChart = null;
        let dailyTransactionChart = null;
        let currentFilter = 'all';

        const menuItems = [
            { id: 'dashboard', name: 'Dashboard', svg: '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>' },
            { id: 'transactions', name: 'Transa√ß√µes', svg: '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>' },
            { id: 'categories', name: 'Categorias', svg: '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h7l3 3h6a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2z"/></svg>' },
            { id: 'reports', name: 'Relat√≥rios', svg: '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 3v18h18"/><path d="M18 17V9"/><path d="M13 17V5"/><path d="M8 17v-3"/></svg>' },
            { id: 'contracts', name: 'Contratos', svg: '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><path d="M14 2v6h6"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><line x1="10" y1="9" x2="8" y2="9"/></svg>' },
            { id: 'goals', name: 'Metas Financeiras', svg: '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>' },
            { id: 'settings', name: 'Configura√ß√µes', svg: '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M12 1v6m0 6v6M5.6 5.6l4.2 4.2m4.2 4.2l4.2 4.2M1 12h6m6 0h6M5.6 18.4l4.2-4.2m4.2-4.2l4.2-4.2"/></svg>' }
        ];

        const contractTemplates = {
            service: `CONTRATO DE PRESTA√á√ÉO DE SERVI√áOS

CONTRATANTE: [Nome do Contratante]
CPF/CNPJ: [000.000.000-00]

CONTRATADO: [Nome do Contratado]
CPF/CNPJ: [000.000.000-00]

OBJETO: Presta√ß√£o de servi√ßos de [descri√ß√£o do servi√ßo]

VALOR: R$ [valor]

PRAZO: [prazo de execu√ß√£o]

DATA: [data atual]

_______________________          _______________________
    CONTRATANTE                      CONTRATADO`,

            work: `CONTRATO DE TRABALHO

EMPREGADOR: [Nome da Empresa]
CNPJ: [00.000.000/0000-00]

EMPREGADO: [Nome do Empregado]
CPF: [000.000.000-00]

CARGO: [cargo/fun√ß√£o]

SAL√ÅRIO: R$ [valor]

JORNADA: [horas semanais]

DATA DE IN√çCIO: [data]

_______________________          _______________________
    EMPREGADOR                       EMPREGADO`,

            rent: `CONTRATO DE LOCA√á√ÉO

LOCADOR: [Nome do Locador]
CPF: [000.000.000-00]

LOCAT√ÅRIO: [Nome do Locat√°rio]
CPF: [000.000.000-00]

IM√ìVEL: [endere√ßo completo]

VALOR: R$ [valor mensal]

PRAZO: [per√≠odo de loca√ß√£o]

DATA: [data atual]

_______________________          _______________________
     LOCADOR                         LOCAT√ÅRIO`,

            sale: `CONTRATO DE COMPRA E VENDA

VENDEDOR: [Nome do Vendedor]
CPF: [000.000.000-00]

COMPRADOR: [Nome do Comprador]
CPF: [000.000.000-00]

OBJETO: [descri√ß√£o do bem]

VALOR: R$ [valor]

FORMA DE PAGAMENTO: [condi√ß√µes]

DATA: [data atual]

_______________________          _______________________
     VENDEDOR                        COMPRADOR`
        };

        function generateFavicon() {
            const canvas = document.createElement('canvas');
            canvas.width = 64;
            canvas.height = 64;
            const ctx = canvas.getContext('2d');

            ctx.fillStyle = '#5B2CFF';
            ctx.beginPath();
            ctx.arc(32, 32, 30, 0, Math.PI * 2);
            ctx.fill();

            ctx.fillStyle = '#ffffff';
            ctx.font = 'bold 40px Inter';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText('K', 32, 32);

            const link = document.createElement('link');
            link.type = 'image/x-icon';
            link.rel = 'shortcut icon';
            link.href = canvas.toDataURL('image/png');
            document.head.appendChild(link);
        }

        generateFavicon();

        function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open('FinanceDB', 1);

                request.onerror = () => reject(request.error);
                request.onsuccess = () => {
                    db = request.result;
                    resolve(db);
                };

                request.onupgradeneeded = (event) => {
                    db = event.target.result;

                    if (!db.objectStoreNames.contains('transactions')) {
                        const transactionStore = db.createObjectStore('transactions', { keyPath: 'id', autoIncrement: true });
                        transactionStore.createIndex('date', 'date', { unique: false });
                        transactionStore.createIndex('category', 'category', { unique: false });
                    }

                    if (!db.objectStoreNames.contains('categories')) {
                        db.createObjectStore('categories', { keyPath: 'id', autoIncrement: true });
                    }

                    if (!db.objectStoreNames.contains('settings')) {
                        db.createObjectStore('settings', { keyPath: 'key' });
                    }

                    if (!db.objectStoreNames.contains('goals')) {
                        db.createObjectStore('goals', { keyPath: 'id', autoIncrement: true });
                    }
                };
            });
        }

        async function getAll(storeName) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([storeName], 'readonly');
                const store = transaction.objectStore(storeName);
                const request = store.getAll();

                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        async function add(storeName, data) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([storeName], 'readwrite');
                const store = transaction.objectStore(storeName);
                const request = store.add(data);

                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        async function update(storeName, data) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([storeName], 'readwrite');
                const store = transaction.objectStore(storeName);
                const request = store.put(data);

                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        async function remove(storeName, id) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([storeName], 'readwrite');
                const store = transaction.objectStore(storeName);
                const request = store.delete(id);

                request.onsuccess = () => resolve();
                request.onerror = () => reject(request.error);
            });
        }

        async function initDefaultCategories() {
            const categories = await getAll('categories');
            if (categories.length === 0) {
                const defaults = [
                    { name: 'Alimenta√ß√£o', color: '#FF6B6B' },
                    { name: 'Transporte', color: '#4ECDC4' },
                    { name: 'Moradia', color: '#45B7D1' },
                    { name: 'Lazer', color: '#FFA07A' },
                    { name: 'Sa√∫de', color: '#98D8C8' },
                    { name: 'Educa√ß√£o', color: '#6C5CE7' },
                    { name: 'Sal√°rio', color: '#00C853' },
                    { name: 'Investimentos', color: '#5B2CFF' }
                ];

                for (const cat of defaults) {
                    await add('categories', cat);
                }
            }
        }

        function renderMenu() {
            const menu = document.getElementById('menu');
            menu.innerHTML = menuItems.map(item => `
                <div class="menu-item ${item.id === currentSection ? 'active' : ''}" onclick="navigateTo('${item.id}')">
                    ${item.svg}
                    <span>${item.name}</span>
                </div>
            `).join('');
        }

        function navigateTo(section) {
            currentSection = section;
            renderMenu();
            renderContent();
        }

        async function renderContent() {
            const content = document.getElementById('content');

            switch(currentSection) {
                case 'dashboard':
                    await renderDashboard();
                    break;
                case 'transactions':
                    await renderTransactions();
                    break;
                case 'categories':
                    await renderCategories();
                    break;
                case 'reports':
                    await renderReports();
                    break;
                case 'contracts':
                    renderContracts();
                    break;
                case 'goals':
                    await renderGoals();
                    break;
                case 'settings':
                    renderSettings();
                    break;
            }
        }

        async function renderDashboard() {
            const transactions = await getAll('transactions');
            const categories = await getAll('categories');

            const totalIncome = transactions.filter(t => t.type === 'income').reduce((sum, t) => sum + parseFloat(t.value), 0);
            const totalOutcome = transactions.filter(t => t.type === 'outcome').reduce((sum, t) => sum + parseFloat(t.value), 0);
            const balance = totalIncome - totalOutcome;

            document.getElementById('totalBalance').textContent = formatCurrency(balance);

            const content = document.getElementById('content');
            content.innerHTML = `
                <div class="dashboard-grid">
                    <div class="card">
                        <div class="stat-label">Entradas</div>
                        <div class="stat-value" style="color: var(--success)">${formatCurrency(totalIncome)}</div>
                    </div>
                    <div class="card">
                        <div class="stat-label">Sa√≠das</div>
                        <div class="stat-value" style="color: var(--danger)">${formatCurrency(totalOutcome)}</div>
                    </div>
                </div>

                <div class="card" style="margin-bottom: 1.5rem;">
                    <div class="card-header">
                        Transa√ß√µes Di√°rias
                        <div class="filter-controls">
                            <button class="filter-btn ${currentFilter === 'all' ? 'active' : ''}" onclick="setDailyFilter('all')">Todos</button>
                            <button class="filter-btn ${currentFilter === '7' ? 'active' : ''}" onclick="setDailyFilter('7')">7 dias</button>
                            <button class="filter-btn ${currentFilter === '30' ? 'active' : ''}" onclick="setDailyFilter('30')">30 dias</button>
                        </div>
                    </div>
                    <canvas id="dailyTransactionChart"></canvas>
                </div>

                <div class="card" style="margin-bottom: 1.5rem;">
                    <div class="card-header">Distribui√ß√£o por Categoria</div>
                    <canvas id="categoryChart"></canvas>
                </div>

                <div class="card">
                    <div class="card-header">√öltimas Transa√ß√µes</div>
                    <div class="transaction-list" id="recentTransactions"></div>
                </div>
            `;

            renderRecentTransactions();
            renderCategoryChart(transactions, categories);
            renderDailyTransactionChart(transactions);
        }

        async function setDailyFilter(filter) {
            currentFilter = filter;
            const transactions = await getAll('transactions');
            renderDailyTransactionChart(transactions);
            
            const buttons = document.querySelectorAll('.filter-btn');
            buttons.forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
        }

        async function renderDailyTransactionChart(transactions) {
            const now = new Date();
            let filteredTransactions = transactions;

            if (currentFilter !== 'all') {
                const days = parseInt(currentFilter);
                const startDate = new Date(now.getTime() - days * 24 * 60 * 60 * 1000);
                filteredTransactions = transactions.filter(t => new Date(t.date) >= startDate);
            }

            const dailyData = {};
            
            filteredTransactions.forEach(t => {
                const date = t.date;
                if (!dailyData[date]) {
                    dailyData[date] = { income: 0, outcome: 0 };
                }
                if (t.type === 'income') {
                    dailyData[date].income += parseFloat(t.value);
                } else {
                    dailyData[date].outcome += parseFloat(t.value);
                }
            });

            const sortedDates = Object.keys(dailyData).sort();
            const labels = sortedDates.map(date => {
                const d = new Date(date + 'T00:00:00');
                return `${d.getDate()}/${d.getMonth() + 1}`;
            });
            const incomeData = sortedDates.map(date => dailyData[date].income);
            const outcomeData = sortedDates.map(date => dailyData[date].outcome);

            if (dailyTransactionChart) {
                dailyTransactionChart.destroy();
            }

            const ctx = document.getElementById('dailyTransactionChart');
            if (!ctx) return;

            dailyTransactionChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Entradas',
                            data: incomeData,
                            backgroundColor: '#00C853',
                            borderColor: '#00C853',
                            borderWidth: 1
                        },
                        {
                            label: 'Sa√≠das',
                            data: outcomeData,
                            backgroundColor: '#FF3D00',
                            borderColor: '#FF3D00',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: true,
                            labels: {
                                color: getComputedStyle(document.body).getPropertyValue('--text-primary')
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + formatCurrency(context.parsed.y);
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: getComputedStyle(document.body).getPropertyValue('--text-secondary'),
                                callback: function(value) {
                                    return 'R$ ' + value.toFixed(0);
                                }
                            },
                            grid: {
                                color: getComputedStyle(document.body).getPropertyValue('--border')
                            }
                        },
                        x: {
                            ticks: {
                                color: getComputedStyle(document.body).getPropertyValue('--text-secondary')
                            },
                            grid: {
                                color: getComputedStyle(document.body).getPropertyValue('--border')
                            }
                        }
                    }
                }
            });
        }

        async function renderRecentTransactions() {
            const transactions = await getAll('transactions');
            const recent = transactions.sort((a, b) => new Date(b.date) - new Date(a.date)).slice(0, 5);

            const container = document.getElementById('recentTransactions');
            if (!container) return;

            if (recent.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">Nenhuma transa√ß√£o ainda</p>';
                return;
            }

            container.innerHTML = recent.map(t => `
                <div class="transaction-item">
                    <div class="transaction-info">
                        <div class="transaction-category">${t.category}</div>
                        <div class="transaction-date">${formatDate(t.date)} ${t.description ? '- ' + t.description : ''}</div>
                    </div>
                    <div class="transaction-value ${t.type}">${t.type === 'income' ? '+' : '-'} ${formatCurrency(t.value)}</div>
                </div>
            `).join('');
        }

        function renderCategoryChart(transactions, categories) {
            const categoryTotals = {};
            const categoryColors = {};

            categories.forEach(cat => {
                categoryColors[cat.name] = cat.color;
            });

            transactions.filter(t => t.type === 'outcome').forEach(t => {
                categoryTotals[t.category] = (categoryTotals[t.category] || 0) + parseFloat(t.value);
            });

            const labels = Object.keys(categoryTotals);
            const data = Object.values(categoryTotals);
            const colors = labels.map(label => categoryColors[label] || '#5B2CFF');

            if (categoryChart) {
                categoryChart.destroy();
            }

            const ctx = document.getElementById('categoryChart');
            if (!ctx) return;

            categoryChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: colors,
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: getComputedStyle(document.body).getPropertyValue('--text-primary'),
                                padding: 15
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.label + ': ' + formatCurrency(context.parsed);
                                }
                            }
                        }
                    }
                }
            });
        }

        async function renderTransactions() {
            const transactions = await getAll('transactions');
            const categories = await getAll('categories');

            const content = document.getElementById('content');
            content.innerHTML = `
                <div class="card">
                    <div class="card-header">
                        Todas as Transa√ß√µes
                        <button class="btn btn-primary" onclick="openTransactionModal()">+ Adicionar</button>
                    </div>
                    <div class="transaction-list" id="allTransactions"></div>
                </div>
            `;

            const container = document.getElementById('allTransactions');
            if (transactions.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: var(--text-secondary); padding: 2rem;">Nenhuma transa√ß√£o ainda</p>';
                return;
            }

            const sorted = transactions.sort((a, b) => new Date(b.date) - new Date(a.date));

            container.innerHTML = sorted.map(t => `
                <div class="transaction-item">
                    <div class="transaction-info">
                        <div class="transaction-category">${t.category}</div>
                        <div class="transaction-date">${formatDate(t.date)} ${t.description ? '- ' + t.description : ''}</div>
                    </div>
                    <div style="display: flex; gap: 1rem; align-items: center;">
                        <div class="transaction-value ${t.type}">${t.type === 'income' ? '+' : '-'} ${formatCurrency(t.value)}</div>
                        <button class="btn btn-secondary" style="padding: 0.5rem 1rem;" onclick="deleteTransaction(${t.id})">üóëÔ∏è</button>
                    </div>
                </div>
            `).join('');
        }

        async function renderCategories() {
            const categories = await getAll('categories');

            const content = document.getElementById('content');
            content.innerHTML = `
                <div class="card">
                    <div class="card-header">
                        Categorias
                        <button class="btn btn-primary" onclick="openCategoryModal()">+ Adicionar</button>
                    </div>
                    <div class="category-grid" id="categoryGrid"></div>
                </div>
            `;

            const grid = document.getElementById('categoryGrid');
            grid.innerHTML = categories.map(cat => `
                <div class="category-item" onclick="deleteCategory(${cat.id})">
                    <div class="category-color" style="background-color: ${cat.color}"></div>
                    <div>${cat.name}</div>
                </div>
            `).join('');
        }

        async function renderReports() {
            const transactions = await getAll('transactions');
            const categories = await getAll('categories');

            const content = document.getElementById('content');
            content.innerHTML = `
                <div class="card" style="margin-bottom: 1.5rem;">
                    <div class="card-header">
                        Evolu√ß√£o Mensal
                        <button class="btn btn-primary" onclick="exportCSV()">üì• Exportar CSV</button>
                    </div>
                    <canvas id="evolutionChart"></canvas>
                </div>

                <div class="card">
                    <div class="card-header">Comparativo de Categorias</div>
                    <canvas id="categoryCompareChart"></canvas>
                </div>
            `;

            renderEvolutionChart(transactions);
            renderCategoryCompareChart(transactions, categories);
        }

        function renderEvolutionChart(transactions) {
            const monthlyData = {};

            transactions.forEach(t => {
                const date = new Date(t.date);
                const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;

                if (!monthlyData[monthKey]) {
                    monthlyData[monthKey] = { income: 0, outcome: 0 };
                }

                if (t.type === 'income') {
                    monthlyData[monthKey].income += parseFloat(t.value);
                } else {
                    monthlyData[monthKey].outcome += parseFloat(t.value);
                }
            });

            const sortedMonths = Object.keys(monthlyData).sort();
            const labels = sortedMonths.map(m => {
                const [year, month] = m.split('-');
                return `${month}/${year}`;
            });
            const incomeData = sortedMonths.map(m => monthlyData[m].income);
            const outcomeData = sortedMonths.map(m => monthlyData[m].outcome);

            if (evolutionChart) {
                evolutionChart.destroy();
            }

            const ctx = document.getElementById('evolutionChart');
            evolutionChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Entradas',
                            data: incomeData,
                            borderColor: '#00C853',
                            backgroundColor: 'rgba(0, 200, 83, 0.1)',
                            tension: 0.4
                        },
                        {
                            label: 'Sa√≠das',
                            data: outcomeData,
                            borderColor: '#FF3D00',
                            backgroundColor: 'rgba(255, 61, 0, 0.1)',
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            labels: {
                                color: getComputedStyle(document.body).getPropertyValue('--text-primary')
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: getComputedStyle(document.body).getPropertyValue('--text-secondary')
                            },
                            grid: {
                                color: getComputedStyle(document.body).getPropertyValue('--border')
                            }
                        },
                        x: {
                            ticks: {
                                color: getComputedStyle(document.body).getPropertyValue('--text-secondary')
                            },
                            grid: {
                                color: getComputedStyle(document.body).getPropertyValue('--border')
                            }
                        }
                    }
                }
            });
        }

        function renderCategoryCompareChart(transactions, categories) {
            const categoryTotals = {};
            const categoryColors = {};

            categories.forEach(cat => {
                categoryColors[cat.name] = cat.color;
            });

            transactions.filter(t => t.type === 'outcome').forEach(t => {
                categoryTotals[t.category] = (categoryTotals[t.category] || 0) + parseFloat(t.value);
            });

            const labels = Object.keys(categoryTotals);
            const data = Object.values(categoryTotals);
            const colors = labels.map(label => categoryColors[label] || '#5B2CFF');

            if (categoryCompareChart) {
                categoryCompareChart.destroy();
            }

            const ctx = document.getElementById('categoryCompareChart');
            categoryCompareChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Total Gasto',
                        data: data,
                        backgroundColor: colors
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: getComputedStyle(document.body).getPropertyValue('--text-secondary')
                            },
                            grid: {
                                color: getComputedStyle(document.body).getPropertyValue('--border')
                            }
                        },
                        x: {
                            ticks: {
                                color: getComputedStyle(document.body).getPropertyValue('--text-secondary')
                            },
                            grid: {
                                color: getComputedStyle(document.body).getPropertyValue('--border')
                            }
                        }
                    }
                }
            });
        }

        function renderContracts() {
            const content = document.getElementById('content');
            content.innerHTML = `
                <div class="card">
                    <div class="card-header">Gerar Contrato</div>
                    
                    <div class="form-group">
                        <label class="form-label">Tipo de Contrato</label>
                        <select class="form-input" id="contractType" onchange="updateContractPreview()">
                            <option value="service">Presta√ß√£o de Servi√ßos</option>
                            <option value="work">Trabalho</option>
                            <option value="rent">Loca√ß√£o</option>
                            <option value="sale">Compra e Venda</option>
                        </select>
                    </div>

                    <div class="contract-container" id="contractPreview"></div>

                    <div style="display: flex; gap: 1rem;">
                        <button class="btn btn-primary" onclick="copyContract()">üìã Copiar</button>
                        <button class="btn btn-success" onclick="downloadContractPDF()">üìÑ Baixar PDF</button>
                    </div>
                </div>
            `;

            updateContractPreview();
        }

        function updateContractPreview() {
            const type = document.getElementById('contractType').value;
            const preview = document.getElementById('contractPreview');
            preview.textContent = contractTemplates[type];
        }

        function copyContract() {
            const preview = document.getElementById('contractPreview');
            navigator.clipboard.writeText(preview.textContent);
            alert('Contrato copiado para a √°rea de transfer√™ncia!');
        }

        function downloadContractPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const preview = document.getElementById('contractPreview');
            const text = preview.textContent;

            doc.setFontSize(12);
            const lines = doc.splitTextToSize(text, 180);
            doc.text(lines, 15, 15);
            doc.save('contrato.pdf');
        }

        async function renderGoals() {
            const goals = await getAll('goals');

            const content = document.getElementById('content');
            content.innerHTML = `
                <div class="card">
                    <div class="card-header">
                        Metas Financeiras
                        <button class="btn btn-primary" onclick="openGoalModal()">+ Adicionar Meta</button>
                    </div>
                    <div id="goalsList"></div>
                </div>
            `;

            const goalsList = document.getElementById('goalsList');

            if (goals.length === 0) {
                goalsList.innerHTML = '<p style="text-align: center; color: var(--text-secondary); padding: 2rem;">Nenhuma meta definida ainda</p>';
                return;
            }

            goalsList.innerHTML = goals.map(goal => {
                const progress = (goal.current / goal.target) * 100;
                const remaining = goal.target - goal.current;
                const daysLeft = goal.deadline ? Math.ceil((new Date(goal.deadline) - new Date()) / (1000 * 60 * 60 * 24)) : null;

                return `
                    <div class="card" style="margin-bottom: 1rem; background: var(--bg-secondary);">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                            <div>
                                <h3 style="margin-bottom: 0.5rem;">${goal.name}</h3>
                                <p style="color: var(--text-secondary); font-size: 0.875rem;">
                                    ${formatCurrency(goal.current)} de ${formatCurrency(goal.target)}
                                    ${daysLeft !== null ? ` ‚Ä¢ ${daysLeft} dias restantes` : ''}
                                </p>
                            </div>
                            <button class="btn btn-danger" style="padding: 0.5rem 1rem;" onclick="deleteGoal(${goal.id})">üóëÔ∏è</button>
                        </div>
                        
                        <div style="background: var(--bg-primary); height: 20px; border-radius: 10px; overflow: hidden; margin-bottom: 0.5rem;">
                            <div style="background: ${progress >= 100 ? 'var(--success)' : 'var(--accent)'}; height: 100%; width: ${Math.min(progress, 100)}%; transition: width 0.3s;"></div>
                        </div>
                        
                        <div style="display: flex; justify-content: space-between; font-size: 0.875rem;">
                            <span>${progress.toFixed(1)}% conclu√≠do</span>
                            <span style="color: ${remaining > 0 ? 'var(--danger)' : 'var(--success)'}">
                                ${remaining > 0 ? `Faltam ${formatCurrency(remaining)}` : 'Meta atingida! üéâ'}
                            </span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderSettings() {
            const content = document.getElementById('content');
            content.innerHTML = `
                <div class="card">
                    <div class="card-header">Configura√ß√µes</div>

                    <div class="form-group">
                        <label class="form-label">Tema</label>
                        <button class="btn btn-secondary" onclick="toggleTheme()">Alternar Tema</button>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Backup de Dados</label>
                        <div style="display: flex; gap: 1rem;">
                            <button class="btn btn-primary" onclick="backupData()">üíæ Fazer Backup</button>
                            <button class="btn btn-secondary" onclick="document.getElementById('restoreInput').click()">üìÇ Restaurar</button>
                            <input type="file" id="restoreInput" accept=".json" style="display: none;" onchange="restoreData(event)">
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Limpar Dados</label>
                        <button class="btn btn-danger" onclick="clearAllData()">üóëÔ∏è Limpar Tudo</button>
                    </div>
                </div>
            `;
        }

        function openTransactionModal() {
            loadCategoriesIntoSelect();
            document.getElementById('transactionDate').valueAsDate = new Date();
            document.getElementById('transactionModal').classList.add('active');
        }

        function closeTransactionModal() {
            document.getElementById('transactionModal').classList.remove('active');
            document.getElementById('transactionForm').reset();
            editingTransactionId = null;
        }

        async function loadCategoriesIntoSelect() {
            const categories = await getAll('categories');
            const select = document.getElementById('transactionCategory');
            select.innerHTML = categories.map(cat => `
                <option value="${cat.name}">${cat.name}</option>
            `).join('');
        }

        document.getElementById('transactionForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const transaction = {
                value: document.getElementById('transactionValue').value,
                type: document.getElementById('transactionType').value,
                category: document.getElementById('transactionCategory').value,
                date: document.getElementById('transactionDate').value,
                description: document.getElementById('transactionDescription').value
            };

            if (editingTransactionId) {
                transaction.id = editingTransactionId;
                await update('transactions', transaction);
            } else {
                await add('transactions', transaction);
            }

            closeTransactionModal();
            renderContent();
        });

        async function deleteTransaction(id) {
            if (confirm('Deseja realmente excluir esta transa√ß√£o?')) {
                await remove('transactions', id);
                renderContent();
            }
        }

        function openCategoryModal() {
            document.getElementById('categoryModal').classList.add('active');
        }

        function closeCategoryModal() {
            document.getElementById('categoryModal').classList.remove('active');
            document.getElementById('categoryForm').reset();
            editingCategoryId = null;
        }

        document.getElementById('categoryForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const category = {
                name: document.getElementById('categoryName').value,
                color: document.getElementById('categoryColor').value
            };

            if (editingCategoryId) {
                category.id = editingCategoryId;
                await update('categories', category);
            } else {
                await add('categories', category);
            }

            closeCategoryModal();
            renderContent();
        });

        async function deleteCategory(id) {
            if (confirm('Deseja realmente excluir esta categoria?')) {
                await remove('categories', id);
                renderContent();
            }
        }

        function openGoalModal() {
            document.getElementById('goalModal').classList.add('active');
        }

        function closeGoalModal() {
            document.getElementById('goalModal').classList.remove('active');
            document.getElementById('goalForm').reset();
            editingGoalId = null;
        }

        document.getElementById('goalForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const goal = {
                name: document.getElementById('goalName').value,
                target: parseFloat(document.getElementById('goalTarget').value),
                current: parseFloat(document.getElementById('goalCurrent').value),
                deadline: document.getElementById('goalDeadline').value
            };

            if (editingGoalId) {
                goal.id = editingGoalId;
                await update('goals', goal);
            } else {
                await add('goals', goal);
            }

            closeGoalModal();
            renderContent();
        });

        async function deleteGoal(id) {
            if (confirm('Deseja realmente excluir esta meta?')) {
                await remove('goals', id);
                renderContent();
            }
        }

        function toggleTheme() {
            document.body.classList.toggle('dark');
            const theme = document.body.classList.contains('dark') ? 'dark' : 'light';
            localStorage.setItem('theme', theme);
            
            if (categoryChart) renderContent();
        }

        async function backupData() {
            const transactions = await getAll('transactions');
            const categories = await getAll('categories');
            const goals = await getAll('goals');

            const backup = {
                transactions,
                categories,
                goals,
                date: new Date().toISOString()
            };

            const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `kdefy-backup-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
        }

        async function restoreData(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const backup = JSON.parse(e.target.result);

                    const stores = ['transactions', 'categories', 'goals'];
                    for (const store of stores) {
                        const transaction = db.transaction([store], 'readwrite');
                        const objectStore = transaction.objectStore(store);
                        objectStore.clear();

                        if (backup[store]) {
                            for (const item of backup[store]) {
                                objectStore.add(item);
                            }
                        }
                    }

                    alert('Dados restaurados com sucesso!');
                    renderContent();
                } catch (error) {
                    alert('Erro ao restaurar dados: ' + error.message);
                }
            };
            reader.readAsText(file);
        }

        async function clearAllData() {
            if (confirm('Tem certeza? Todos os dados ser√£o apagados permanentemente!')) {
                const stores = ['transactions', 'categories', 'goals'];
                for (const store of stores) {
                    const transaction = db.transaction([store], 'readwrite');
                    const objectStore = transaction.objectStore(store);
                    objectStore.clear();
                }

                await initDefaultCategories();
                alert('Dados limpos com sucesso!');
                renderContent();
            }
        }

        async function exportCSV() {
            const transactions = await getAll('transactions');
            
            let csv = 'Data,Tipo,Categoria,Valor,Descri√ß√£o\n';
            transactions.forEach(t => {
                csv += `${t.date},${t.type === 'income' ? 'Entrada' : 'Sa√≠da'},${t.category},${t.value},"${t.description || ''}"\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `transacoes-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
        }

        function formatCurrency(value) {
            return new Intl.NumberFormat('pt-BR', {
                style: 'currency',
                currency: 'BRL'
            }).format(value);
        }

        function formatDate(dateString) {
            const date = new Date(dateString + 'T00:00:00');
            return date.toLocaleDateString('pt-BR');
        }

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('collapsed');
        }

        function enterApp() {
            document.getElementById('landingPage').style.display = 'none';
            document.getElementById('appContainer').classList.add('active');
            init();
        }

        async function init() {
            await initDB();
            await initDefaultCategories();

            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                document.body.classList.add('dark');
            }

            renderMenu();
            renderContent();
        }

        if (window.location.hash === '#app') {
            enterApp();
        }
    </script>
</body>
</html>
